@model Template.Web.Features.Visitor.VisitorSummaryModel

@{
	// Genera un codice breve a partire dal Guid (5 caratteri alfanumerici)
	string guidStr = Model?.Id.ToString() ?? Guid.NewGuid().ToString();
	string ShortFromGuid(string g)
	{
		try
		{
			var bytes = Guid.Parse(g).ToByteArray();
			// Prendiamo 6 bytes e costruiamo un valore numerico
			ulong val = 0;
			for (int i = 0; i < 6; i++) val = (val << 8) | bytes[i];
			const string alphabet = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
			var sb = new System.Text.StringBuilder();
			// convert to base (36) and build at least 5 chars
			while (sb.Length < 5)
			{
				var idx = (int)(val % (ulong)alphabet.Length);
				sb.Insert(0, alphabet[idx]);
				val /= (ulong)alphabet.Length;
				if (val == 0) val = (ulong)((DateTime.UtcNow.Ticks) & 0xFFFFFFFFFFFF); // fallback entropy
			}
			return sb.ToString().Substring(0,5);
		}
		catch { return guidStr.Substring(0,5).ToUpperInvariant(); }
	}
	var shortCode = ShortFromGuid(guidStr);
}

<!-- Aggiunto: font e stili coerenti con Reception/Visitor -->
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Nunito', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(90deg, #eef3f7 0%, #f7fbfd 100%);
        color: #1f2937;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
    }
    .container-fluid { padding-top:1.6rem; padding-bottom:1.6rem; width:95%; }

    .card {
        border-radius: 12px;
        background: linear-gradient(180deg,#ffffff 0%,#fbfdff 100%);
        box-shadow: 0 8px 20px rgba(15,23,42,0.06);
        border: 1px solid rgba(15,23,42,0.04);
    }
    .card .card-body { border-radius:10px; padding:1.4rem; background: #fff; } /* FORZA sfondo bianco visibile */

    .badge-success {
        background: transparent;
        color: #059669;
        padding: .45rem .75rem;
        border: 1px solid #059669;
        border-radius: 12px;
        display:inline-block;
    }

    .muted-small { color:#6b7280; font-size:.95rem; }
    .btn { border-radius:10px; }
    .btn-primary { background: #FF5A3C; color: #fff; border: none; }
</style>

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-sm-10 col-md-8 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body text-center" id="receiptCard">
                    <div class="mb-3">
                        <span class="badge-success">✅ Confermato</span>
                    </div>

                    <h2 class="h4 fw-bold mb-1">Grazie!</h2>
                    <div class="muted-small mb-3">Il tuo check‑in è stato registrato correttamente.</div>

                    <div class="text-start mx-auto" style="max-width:420px;">
                        <dl class="row justify-content-center mx-auto">
                            <dt class="col-3 muted-small object-fit-scale px-0">Codice visita</dt>
                            <dd class="col-2 px-0 fw-bold" id="shortCode">@shortCode</dd>
                        </dl>
                        <div class="muted-small text-center">Riceverai eventuali comunicazioni all'indirizzo fornito.</div>
                    </div>

                    <div class="d-flex gap-2 mt-4 justify-content-center">
                        <button id="downloadReceiptBtn" type="button" class="btn btn-primary" style="border-radius:10px; padding:.55rem .9rem;">
                            Scarica ricevuta login
                        </button>
                    </div>
                </div>
            </div>

            <div class="text-muted small mt-3 text-center">Nota: i dati sono stati salvati nel registro visite.</div>
        </div>
    </div>
</div>

<!-- html2canvas CDN + script per scaricare la ricevuta come immagine -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
(function(){
    var btn = document.getElementById('downloadReceiptBtn');
    if (!btn) return;

    function filenameSafe(s){ return String(s||'receipt').replace(/[^a-z0-9_\-]/gi,'_').toLowerCase(); }

    btn.addEventListener('click', function(){
        var card = document.getElementById('receiptCard');
        if (!card) { alert('Elemento ricevuta non trovato.'); return; }

        // nascondi il bottone prima dello screen (per evitare che appaia)
        var origDisplay = btn.style.display;
        btn.style.display = 'none';

        // qualità su mobile
        var scale = Math.max(1, window.devicePixelRatio || 1);

        html2canvas(card, {
            scale: scale,
            useCORS: true,
            backgroundColor: '#ffffff' // FORZA sfondo bianco nel PNG
        }).then(function(canvas){
            try {
                var idText = document.getElementById('shortCode') ? document.getElementById('shortCode').innerText : '';
                var ts = new Date().toISOString().replace(/[:.]/g,'-');
                var fname = 'ricevuta-' + filenameSafe(idText) + '.png';
                canvas.toBlob(function(blob){
                    var a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = fname;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                }, 'image/png');
            } finally {
                btn.style.display = origDisplay;
            }
        }).catch(function(err){
            btn.style.display = origDisplay;
            console.error('Errore generazione immagine ricevuta', err);
            alert('Si è verificato un errore durante la generazione della ricevuta.');
        });
    });
})();
</script>
