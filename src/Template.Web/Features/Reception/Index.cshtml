@{
    Layout = "_Layout";
}
<link rel="stylesheet" href="@Url.Content("/css/reception.css")" />
<div class="container-fluid py-4">
    <div class="d-flex align-items-start gap-3 mb-3">
        <div>
            <h1 class="h3 mb-1">üõéÔ∏è Reception Live</h1>
            <p class="text-muted mb-0">Monitoraggio check-in/check-out in tempo reale con SignalR</p>
        </div>
        <div class="ms-auto">
            <span id="status" class="badge bg-warning text-dark">Connessione...</span>
        </div>
    </div>

    <div class="row gx-4">
        <!-- Main column -->
        <div class="col-lg-9">
            <!-- Stats -->
            <div class="row mb-3 g-3">
                <div class="col-sm-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">Presenti ora</small>
                                    <div id="presentNow" class="h4 mb-0">0</div>
                                </div>
                                <div class="text-success fs-3"><i class="fas fa-user-check"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <small class="text-muted">Ultimo check‚Äëin</small>
                            <div id="lastCheckin" class="h6 mb-0">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <small class="text-muted">Totale registri</small>
                            <div id="totalRecords" class="h6 mb-0">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <div class="row gy-2 gx-2 align-items-center">
                        <div class="col-md-5">
                            <input id="filterSearch" class="form-control" placeholder="Cerca email, nome, cognome, QR..." />
                        </div>
                        <div class="col-auto">
                            <input id="filterStart" type="date" class="form-control" />
                        </div>
                        <div class="col-auto">
                            <input id="filterEnd" type="date" class="form-control" />
                        </div>
                        <div class="col-auto d-flex align-items-center">
                            <input id="filterPresent" class="form-check-input me-1" type="checkbox" />
                            <label class="form-check-label mb-0">Solo presenti</label>
                        </div>
                        <div class="col-auto">
                            <button id="applyFilters" class="btn btn-outline-secondary btn-sm">Applica</button>
                            <button id="clearFilters" class="btn btn-outline-secondary btn-sm">Reset</button>
                        </div>
                        <div class="col text-end">
                            <button id="exportBtn" class="btn btn-success btn-sm">Esporta Excel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="visits" class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="min-width:220px;">#</th>
                                    <th>QR</th>
                                    <th>Email</th>
                                    <th>Nome</th>
                                    <th>Cognome</th>
                                    <th>Entrata</th>
                                    <th>Uscita</th>
                                    <th style="width:120px;">Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- rows populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-muted small">
                    <span id="visitCount">Visitatori attualmente presenti: 0</span>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-3">
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="card-title">Dettaglio visitatore</h6>
                    <div id="detailEmpty" class="text-muted">Seleziona una riga per vedere i dettagli</div>
                    <div id="detailPane" class="d-none">
                        <div class="mb-2"><strong id="detailName">-</strong></div>
                        <div class="mb-1"><small class="text-muted">Email</small><div id="detailEmail">-</div></div>
                        <div class="mb-1"><small class="text-muted">QR</small><div id="detailQr">-</div></div>
                        <div class="mb-1"><small class="text-muted">Entrata</small><div id="detailIn">-</div></div>
                        <div class="mb-1"><small class="text-muted">Uscita</small><div id="detailOut">-</div></div>
                        <div class="mt-3 d-flex gap-2">
                            <button id="detailCheckoutBtn" class="btn btn-danger btn-sm">Segna uscita</button>
                            <button id="detailEditBtn" class="btn btn-outline-primary btn-sm">Modifica</button>
                            <button id="detailDeleteBtn" class="btn btn-outline-danger btn-sm">Elimina</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title">Azioni rapide</h6>
                    <button id="exportBtn2" class="btn btn-success btn-sm w-100 mb-2">Esporta Excel</button>
                    <button id="resetView" class="btn btn-outline-secondary btn-sm w-100">Reset filtri</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <style>
        .card .card-body small { color: #6b7280; }
        tr.selected { background: linear-gradient(90deg, rgba(99,102,241,0.06), rgba(255,255,255,0)); }
    </style>

    <!-- CORRETTO: carica la libreria SignalR dal CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>

    <script>
        // elementi
        const tbody = document.querySelector('#visits tbody');
        const statusEl = document.getElementById('status');
        const presentNowEl = document.getElementById('presentNow');
        const lastCheckinEl = document.getElementById('lastCheckin');
        const totalRecordsEl = document.getElementById('totalRecords');
        const visitCountEl = document.getElementById('visitCount');
        const detailPane = document.getElementById('detailPane');
        const detailEmpty = document.getElementById('detailEmpty');
        const detailName = document.getElementById('detailName');
        const detailEmail = document.getElementById('detailEmail');
        const detailQr = document.getElementById('detailQr');
        const detailIn = document.getElementById('detailIn');
        const detailOut = document.getElementById('detailOut');
        const detailCheckoutBtn = document.getElementById('detailCheckoutBtn');

        // filters
        const filterSearch = document.getElementById('filterSearch');
        const filterStart = document.getElementById('filterStart');
        const filterEnd = document.getElementById('filterEnd');
        const filterPresent = document.getElementById('filterPresent');
        const applyFiltersBtn = document.getElementById('applyFilters');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const exportBtn = document.getElementById('exportBtn');
        const exportBtn2 = document.getElementById('exportBtn2');

        let selectedId = null;

        function valueOf(o,a,b){ return (o&& (o[a] ?? o[b])) ?? ''; }
        function fmt(d){ if(!d) return ''; const dt=new Date(d); return isNaN(dt.getTime())? '': dt.toLocaleString(); }

        // inizializzazione SignalR robusta (non blocca se falla)
        (function initSignalR(){
            try {
                if (typeof signalR === 'undefined') throw new Error('SignalR library not available');
                const hubPath = window.location.origin + '/templateHub';
                const conn = new signalR.HubConnectionBuilder()
                    .withUrl(hubPath)
                    .withAutomaticReconnect()
                    .build();

                conn.on('NewVisit', v => { console.debug('[SignalR] NewVisit', v); addOrUpdateRow(v); });
                conn.on('UpdateVisit', v => { console.debug('[SignalR] UpdateVisit', v); addOrUpdateRow(v); });

                conn.start()
                    .then(() => {
                        statusEl.classList.remove('bg-warning','text-dark');
                        statusEl.classList.add('bg-success','text-white');
                        statusEl.innerText = 'üü¢ Connesso';
                        console.debug('[SignalR] connected to', hubPath);
                    })
                    .catch(e => {
                        console.error('[SignalR] start failed', e);
                        statusEl.classList.remove('bg-warning');
                        statusEl.classList.add('bg-danger','text-white');
                        statusEl.innerText = 'üî¥ Errore di connessione';
                    });

                conn.onclose(err => {
                    console.warn('[SignalR] connection closed', err);
                    statusEl.classList.remove('bg-success','text-white');
                    statusEl.classList.add('bg-danger','text-white');
                    statusEl.innerText = 'üî¥ Connessione persa';
                });
            } catch (err) {
                console.error('SignalR init error', err);
                statusEl.classList.remove('bg-warning','text-dark');
                statusEl.classList.add('bg-danger','text-white');
                statusEl.innerText = 'üî¥ SignalR non disponibile';
            }
        })();

        function buildQueryParams() {
            const params = new URLSearchParams();
            const q = filterSearch.value.trim();
            if (q) params.set('q', q);
            if (filterStart.value) params.set('start', filterStart.value);
            if (filterEnd.value) params.set('end', filterEnd.value);
            if (filterPresent.checked) params.set('presentOnly', 'true');
            return params.toString();
        }

        applyFiltersBtn?.addEventListener('click', () => loadExistingVisits());
        clearFiltersBtn?.addEventListener('click', () => {
            filterSearch.value=''; filterStart.value=''; filterEnd.value=''; filterPresent.checked=false;
            loadExistingVisits();
        });
        exportBtn?.addEventListener('click', () => { const qs=buildQueryParams(); window.location = '/api/visits/export' + (qs? '?' + qs : ''); });
        exportBtn2?.addEventListener('click', () => { const qs=buildQueryParams(); window.location = '/api/visits/export' + (qs? '?' + qs : ''); });

        function rowClickHandler(id, v){
            selectedId = id;
            document.querySelectorAll('#visits tbody tr').forEach(tr => tr.classList.remove('selected'));
            const tr = document.getElementById('v-' + id);
            if(tr) tr.classList.add('selected');

            detailEmpty.classList.add('d-none');
            detailPane.classList.remove('d-none');
            detailName.innerText = `${valueOf(v,'FirstName','firstName')} ${valueOf(v,'LastName','lastName')}`;
            detailEmail.innerText = valueOf(v,'Email','email');
            detailQr.innerText = valueOf(v,'QrKey','qrKey');
            detailIn.innerText = fmt(valueOf(v,'CheckInTime','checkInTime'));
            detailOut.innerText = fmt(valueOf(v,'CheckOutTime','checkOutTime'));

            // set checkout button state
            if (valueOf(v,'CheckOutTime','checkOutTime')) {
                detailCheckoutBtn.disabled = true;
                detailCheckoutBtn.innerText = 'Uscita registrata';
            } else {
                detailCheckoutBtn.disabled = false;
                detailCheckoutBtn.innerText = 'Segna uscita';
                detailCheckoutBtn.onclick = () => checkoutVisit(id, detailCheckoutBtn);
            }
        }

        function addOrUpdateRow(v) {
            if (!v) return;
            const id = valueOf(v,'Id','id') || valueOf(v,'id','Id');
            if(!id) return;
            let tr = document.getElementById('v-' + id);
            const isNew = !tr;
            if (isNew) {
                tr = document.createElement('tr');
                tr.id = 'v-' + id;
                tbody.prepend(tr);
            }
            const QrKey = valueOf(v,'QrKey','qrKey');
            const Email = valueOf(v,'Email','email');
            const FirstName = valueOf(v,'FirstName','firstName');
            const LastName = valueOf(v,'LastName','lastName');
            const CheckInTime = valueOf(v,'CheckInTime','checkInTime');
            const CheckOutTime = valueOf(v,'CheckOutTime','checkOutTime');

            tr.innerHTML = `
                <td style="min-width:220px">${id}</td>
                <td>${QrKey}</td>
                <td>${Email}</td>
                <td>${FirstName}</td>
                <td>${LastName}</td>
                <td>${fmt(CheckInTime)}</td>
                <td>${fmt(CheckOutTime)}</td>
                <td>
                    ${ CheckOutTime ? 
                        '<button class="btn btn-sm btn-outline-secondary" disabled>Uscito</button>' :
                        `<button class="btn btn-sm btn-danger" onclick="checkoutVisit('${id}', this)">Segna uscita</button>`
                    }
                </td>
            `;

            // bind row click to show details (use current v snapshot)
            tr.onclick = () => rowClickHandler(id, v);

            updateStats();
        }

        async function checkoutVisit(id, btnEl) {
            try {
                btnEl.disabled = true;
                btnEl.innerText = '‚è≥';
                const res = await fetch(`/api/visits/${id}/checkout`, { method: 'POST', credentials: 'same-origin' });
                if (!res.ok) {
                    console.warn('Checkout failed', res.status);
                    btnEl.disabled = false;
                    return;
                }
                const updated = await res.json();
                addOrUpdateRow(updated);
                if(selectedId === id) rowClickHandler(id, updated);
            } catch (e) {
                console.error(e);
            }
        }

        async function loadExistingVisits() {
            try {
                const qs = buildQueryParams();
                const url = '/api/visits' + (qs ? '?' + qs : '');
                console.debug('[Reception] loadExistingVisits ->', url);
                const res = await fetch(url, { credentials: 'same-origin' });
                if (!res.ok) {
                    console.warn('Failed to load persisted visits', res.status);
                    return;
                }
                const arr = await res.json();
                tbody.innerHTML = '';
                if (Array.isArray(arr)) {
                    for (let i = 0; i < arr.length; i++) addOrUpdateRow(arr[i]);
                }
                updateStats();
            } catch (e) {
                console.error(e);
            }
        }

        function updateStats() {
            const rows = Array.from(document.querySelectorAll('#visits tbody tr'));
            totalRecordsEl.innerText = rows.length;
            const present = rows.reduce((acc, tr) => {
                const usc = tr.querySelectorAll('td')[6]?.innerText?.trim();
                return acc + (usc ? 0 : 1);
            }, 0);
            presentNowEl.innerText = present;
            visitCountEl.innerText = `Visitatori attualmente presenti: ${present}`;
            // last checkin (first row)
            const firstRow = rows[0];
            if (firstRow) {
                const lastIn = firstRow.querySelectorAll('td')[5]?.innerText || '';
                lastCheckinEl.innerText = lastIn;
            } else {
                lastCheckinEl.innerText = '-';
            }
            document.getElementById('detailEmpty').classList.toggle('d-none', rows.length > 0 && selectedId);
        }

        function openEdit(id){
            const tr = document.getElementById('v-' + id);
            if (!tr) return;
            const cells = tr.querySelectorAll('td');
            const v = {
                Id: id,
                QrKey: cells[1]?.innerText,
                Email: cells[2]?.innerText,
                FirstName: cells[3]?.innerText,
                LastName: cells[4]?.innerText,
                CheckInTime: cells[5]?.innerText,
                CheckOutTime: cells[6]?.innerText
            };
            openEditInDetail(id, v);
        }

        function openEditInDetail(id, v){
            selectedId = id;
            detailEmpty.classList.add('d-none');
            detailPane.classList.remove('d-none');
            detailName.innerHTML = `<input id="edit-first" class="form-control form-control-sm" value="${escapeHtml(valueOf(v,'FirstName','firstName'))}" />`;
            detailEmail.innerHTML = `<input id="edit-email" class="form-control form-control-sm" value="${escapeHtml(valueOf(v,'Email','email'))}" />`;
            detailQr.innerHTML = `<input id="edit-qr" class="form-control form-control-sm" value="${escapeHtml(valueOf(v,'QrKey','qrKey'))}" />`;
            detailIn.innerHTML = `<input id="edit-in" class="form-control form-control-sm" value="${escapeHtml(fmt(valueOf(v,'CheckInTime','checkInTime')))}" />`;
            detailOut.innerHTML = `<input id="edit-out" class="form-control form-control-sm" value="${escapeHtml(fmt(valueOf(v,'CheckOutTime','checkOutTime')))}" />`;
            detailCheckoutBtn.style.display = 'none';
            editBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
            const save = document.createElement('button'); save.className='btn btn-success btn-sm'; save.innerText='Salva';
            save.onclick = async ()=>{ await saveEdits(id); };
            const cancel = document.createElement('button'); cancel.className='btn btn-outline-secondary btn-sm'; cancel.innerText='Annulla';
            cancel.onclick = ()=>{ const tr=document.getElementById('v-'+id); if(tr){ const c=tr.querySelectorAll('td'); rowClickHandler(id,{ FirstName:c[3]?.innerText, LastName:c[4]?.innerText, Email:c[2]?.innerText, QrKey:c[1]?.innerText, CheckInTime:c[5]?.innerText, CheckOutTime:c[6]?.innerText }); } else { detailPane.classList.add('d-none'); detailEmpty.classList.remove('d-none'); } };
            const actions = detailCheckoutBtn.parentElement;
            actions.appendChild(save);
            actions.appendChild(cancel);
        }

        async function saveEdits(id){
            try{
                const payload = {
                    FirstName: document.getElementById('edit-first')?.value || '',
                    Email: document.getElementById('edit-email')?.value || '',
                    QrKey: document.getElementById('edit-qr')?.value || ''
                };
                const res = await fetch(`/api/visits/${id}`, {
                    method: 'PUT',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if(!res.ok){ alert('Salvataggio fallito'); return; }
                const updated = await res.json();
                addOrUpdateRow(updated);
                if(selectedId === id) rowClickHandler(id, updated);
            }catch(e){ console.error(e); alert('Errore salvataggio'); }
            finally{
                detailCheckoutBtn.style.display = '';
                editBtn.style.display = '';
                deleteBtn.style.display = '';
                const actions = detailCheckoutBtn.parentElement;
                Array.from(actions.querySelectorAll('button')).forEach(b => { if(b.innerText === 'Salva' || b.innerText === 'Annulla') b.remove(); });
            }
        }

        async function deleteVisit(id, btnEl){
            if(!confirm('Eliminare questa entry?')) return;
            try{
                btnEl.disabled = true;
                const tokenMeta = document.querySelector('meta[name="RequestVerificationToken"]')?.getAttribute('content');
                const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                const headers = {};
                if(tokenMeta) headers['RequestVerificationToken'] = tokenMeta;
                else if(tokenInput) headers['RequestVerificationToken'] = tokenInput;
                const res = await fetch(`/api/visits/${id}`, { method: 'DELETE', credentials: 'same-origin', headers });
                if(!res.ok){
                    let body='';
                    try{ body = await res.text(); }catch{}
                    alert(`Eliminazione fallita (${res.status})${body ? ': ' + body : ''}`);
                    btnEl.disabled = false;
                    return;
                }
                const tr = document.getElementById('v-' + id);
                if(tr) tr.remove();
                updateStats();
                if(selectedId === id){ selectedId = null; detailPane.classList.add('d-none'); detailEmpty.classList.remove('d-none'); }
            }catch(e){ console.error(e); alert('Errore eliminazione'); if(btnEl) btnEl.disabled = false; }
        }

        function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

        // init load (always call, independent from SignalR)
        loadExistingVisits();
    </script>
}